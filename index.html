<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peta Sebaran Apotek - Analisis GIS Kota Sukabumi</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <style>
    /* 1. Global & Header Styling */
    body {
      margin: 0;
      font-family: "Poppins", "Segoe UI", sans-serif;
      background-color: #f8f9fa;
    }

    h1 {
      background: linear-gradient(90deg, #0b3c91, #1e6bd6);
      color: #fff;
      text-align: center;
      padding: 18px 0;
      margin: 0;
      font-size: 1.8rem;
      letter-spacing: 1px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    #map {
      height: calc(100vh - 66px);
      width: 100%;
      border-top: 2px solid #0b3c91;
    }

    /* 2. Custom Control Styling (Tombol/Kotak) */

    .locate-btn {
      position: absolute;
      top: 10px;
      left: 60px;
      z-index: 1000;
      background: #0b3c91;
      color: #fff;
      border: none;
      border-radius: 8px;
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
    }

    .locate-btn:hover {
      background: #1e6bd6;
      transform: translateY(-1px);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
    }

    .search-box {
      position: absolute;
      top: 65px;
      left: 10px;
      z-index: 1000;
      background: #fff;
      border-radius: 8px;
      padding: 6px 10px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .search-box input {
      border: none;
      outline: none;
      width: 200px;
      font-size: 0.95rem;
      padding: 2px 0;
    }

    #download-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      font-size: 0.9rem;
      padding: 8px 14px;
      border-radius: 8px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
      transition: 0.3s;
      background-color: #28a745 !important;
      border-color: #28a745 !important;
    }

    #download-btn:hover {
      transform: scale(1.02);
      opacity: 0.9;
    }

    /* 3. Legenda Styling */
    .legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.98);
      padding: 14px 18px;
      border-radius: 12px;
      font-size: 0.9rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      line-height: 1.6em;
      z-index: 1000;
    }

    .legend h6 {
      margin: 0 0 8px;
      font-weight: 700;
      color: #0b3c91;
      border-bottom: 2px solid #eee;
      padding-bottom: 5px;
    }

    .legend i, .legend img {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 10px;
      border-radius: 4px;
      vertical-align: middle;
    }

    .legend i {
        border: 1px solid #ccc;
    }
    
    /* 4. Leaflet Plugin/Popup/Tooltip Styling */
    .leaflet-control-layers {
      border-radius: 8px !important;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    }
    
    .leaflet-control-container .leaflet-control-geocoder {
      border-radius: 8px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    }

    .leaflet-popup-content-wrapper {
      border-radius: 10px;
    }

    .leaflet-tooltip {
      background-color: #0b3c91;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 0.9rem;
      font-weight: 500;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    /* Responsive untuk layar kecil */
    @media (max-width: 600px) {
      .search-box {
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 300px;
      }
      .locate-btn {
        top: 60px;
        left: auto;
        right: 10px;
      }
      #download-btn {
        top: 12px;
        right: 10px;
        padding: 6px 10px;
        font-size: 0.8rem;
      }
      .legend {
        bottom: 5px;
        right: 5px;
        padding: 10px;
        font-size: 0.85rem;
      }
    }
  </style>
</head>

<body>
  <h1>üó∫Ô∏è Peta Sebaran Apotek di Kota Sukabumi</h1>

  <button id="locate-btn" class="locate-btn" title="Tampilkan Lokasi Saya"><i class="fas fa-location-arrow"></i></button>

  <button id="download-btn" class="btn position-absolute">
    <i class="fas fa-download"></i> Unduh Data
  </button>
  
  <div class="search-box">
    <i class="fas fa-search" style="color:#0b3c91;"></i>
    <input type="text" id="search-apotek" placeholder="Cari apotek..." />
  </div>

  <div id="map"></div>

  <div class="legend">
    <h6>Legenda</h6>
    <div><i style="background:#28a745;"></i> Area (Polygon)</div>
    <div><i style="background:#007bff;"></i> Jalur (Polyline)</div>
    <div><i style="background:#ffa500; border-color: #ff8c00;"></i> Buffer 500m</div>
    <div><img src="https://cdn-icons-png.flaticon.com/512/2966/2966327.png" alt="Apotek Icon"> Titik Apotek</div>
    <div style="clear:both"></div>
    <small style="color:#6c757d; display:block; margin-top:10px">
      <i class="fas fa-info-circle"></i> Gunakan Layer Control (kanan atas) untuk melihat analisis.
    </small>
  </div>

  <script>
    // Inisialisasi peta
    var map = L.map("map").setView([-6.919, 106.926], 14);

    // Base maps
    var osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "¬© OpenStreetMap contributors"
    }).addTo(map);

    var satellite = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { attribution: "Tiles ¬© Esri" }
    );

    var topo = L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
      maxZoom: 17,
      attribution: "¬© OpenTopoMap contributors"
    });

    // Layer groups (Original)
    var polylineLayer = L.layerGroup();
    var polygonLayer = L.layerGroup();

    // LAYER GROUP BARU: Marker Clustering (Pengelompokan Penanda)
    var clusterLayer = L.markerClusterGroup({
        spiderfyOnMaxZoom: false,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });

    // LAYER GROUP BARU: Buffer Area Per Apotek (Analisis Kedekatan)
    var individualBufferLayer = L.layerGroup();

    // Layer groups (Analysis)
    var heatLayer = null;
    var centroidLayer = L.layerGroup();
    var serviceAreaLayer = L.layerGroup();
    var densityZoneLayer = L.layerGroup();

    // Icon apotek
    var apotekIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/2966/2966327.png",
      iconSize: [30, 30],
      iconAnchor: [15, 30],
      popupAnchor: [0, -28]
    });

    var apotekData = []; // { name, layer }

    // Muat GeoJSON (nama file: map.geojson)
    fetch("map.geojson")
      .then(res => res.json())
      .then(data => {
        const geojson = L.geoJSON(data, {
          pointToLayer: (feature, latlng) => {
            // 1. BUAT MARKER
            const marker = L.marker(latlng, { icon: apotekIcon });

            // 2. BUAT BUFFER 500m UNTUK SETIAP APOTEK
            L.circle(latlng, {
                radius: 500, // 500 meter
                color: '#ff8c00', 
                fillColor: '#ffa500',
                fillOpacity: 0.15,
                weight: 1 
            })
            .bindPopup(`Area Layanan 500m: <b>${feature.properties.Nama || 'Apotek'}</b>`)
            .addTo(individualBufferLayer);

            return marker;
          },
          style: feature => {
            if (feature.geometry.type === "LineString")
              return { color: "#007bff", weight: 3, dashArray: "5, 5" };
            if (feature.geometry.type === "Polygon")
              return { color: "#28a745", fillOpacity: 0.4, weight: 1.5 };
          },
          onEachFeature: (feature, layer) => {
            const nama = feature.properties["Nama"] || feature.properties["Nama "] || "Apotek";
            layer.bindTooltip(nama, { direction: "top", offset: [0, -15] });

            if (feature.geometry.type === "Point") {
              const latlng = layer.getLatLng();
              layer.bindPopup(`
                <div style="text-align:center; line-height:1.4;">
                  <h6 style="margin-bottom:5px;color:#0b3c91;font-weight:600">${nama}</h6>
                  <p style="margin:2px 0;"><b>Alamat:</b> ${feature.properties.Alamat || "Tidak tersedia"}</p>
                  <p style="margin:2px 0;"><b>Jam Buka:</b> ${feature.properties.Jam || "Tidak diketahui"}</p>
                  <small style="color:#6c757d"><b>Koordinat:</b><br>${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</small>
                </div>
              `);
              
              // Tambah marker ke Cluster Layer
              clusterLayer.addLayer(layer);
              apotekData.push({ name: nama.toLowerCase(), layer });
            }
            if (feature.geometry.type === "LineString") polylineLayer.addLayer(layer);
            if (feature.geometry.type === "Polygon") polygonLayer.addLayer(layer);

            // Efek highlight saat hover
            layer.on({
              mouseover: e => {
                try {
                  e.target.setStyle && e.target.setStyle({ weight: 4, color: "#FFD700", fillOpacity: 0.7 });
                } catch (err) {}
              },
              mouseout: e => {
                try { geojson.resetStyle && geojson.resetStyle(e.target); } catch (err) {}
              }
            });
          }
        });

        // Tambahkan layer utama ke peta
        clusterLayer.addTo(map);
        polylineLayer.addTo(map);
        polygonLayer.addTo(map);

        // -------------------------
        // ANALISIS (dijalankan setelah data dimuat)
        // -------------------------
        setTimeout(() => {
          const markerPoints = [];
          clusterLayer.eachLayer(m => { // Ambil data dari clusterLayer
            if (m.getLatLng) markerPoints.push(m.getLatLng());
          });

          if (markerPoints.length > 0) {
            // 1) Heatmap
            const heatPoints = markerPoints.map(p => [p.lat, p.lng, 0.7]);
            heatLayer = L.heatLayer(heatPoints, { radius: 30, blur: 20, maxZoom: 15 });

            // 2) Centroid (Pusat Kepadatan)
            let sumLat = 0, sumLng = 0;
            markerPoints.forEach(p => { sumLat += p.lat; sumLng += p.lng; });
            const centroid = { lat: sumLat / markerPoints.length, lng: sumLng / markerPoints.length };

            const centroidIcon = L.icon({
              iconUrl: "https://cdn-icons-png.flaticon.com/512/854/854878.png",
              iconSize: [32, 32],
              iconAnchor: [16, 32]
            });
            L.marker([centroid.lat, centroid.lng], { icon: centroidIcon })
              .bindPopup(`<b>Pusat Kepadatan Apotek</b><br>${centroid.lat.toFixed(6)}, ${centroid.lng.toFixed(6)}`).addTo(centroidLayer);

            // 3) Service area 1 km (di sekitar Centroid)
            L.circle([centroid.lat, centroid.lng], {
              radius: 1000,
              color: "#00c853",
              fillColor: "#69f0ae",
              fillOpacity: 0.2
            }).bindPopup("Radius 1 km dari pusat kepadatan").addTo(serviceAreaLayer);

            // 4) Zona Kepadatan
            const zoneSize = 0.004;
            L.polygon([
              [centroid.lat + zoneSize, centroid.lng - zoneSize],
              [centroid.lat + zoneSize, centroid.lng + zoneSize],
              [centroid.lat - zoneSize, centroid.lng + zoneSize],
              [centroid.lat - zoneSize, centroid.lng - zoneSize]
            ], {
              color: "#d50000",
              fillColor: "#ff1744",
              fillOpacity: 0.3
            }).bindPopup("<b>Zona Kepadatan (automatis)</b>").addTo(densityZoneLayer);

            // Tampilkan Heatmap by default
            heatLayer.addTo(map);
          }

          // -------------
          // LAYER CONTROL
          // -------------
          var baseMaps = {
            "üåç OpenStreetMap": osm,
            "üõ∞Ô∏è Satellite (ESRI)": satellite,
            "‚õ∞Ô∏è Topographic": topo
          };

          var overlays = {
            "üè• Titik Apotek (Clustered)": clusterLayer,
            "üõ£Ô∏è Jalur": polylineLayer,
            "üó∫Ô∏è Area (Polygon)": polygonLayer
          };

          // Analisis
          if (individualBufferLayer) overlays["üü† Buffer 500m (Per Apotek)"] = individualBufferLayer;
          if (heatLayer) overlays["üî• Heatmap Kepadatan (On)"] = heatLayer;
          if (centroidLayer) overlays["üìå Centroid Apotek"] = centroidLayer;
          if (serviceAreaLayer) overlays["üü¢ Service Area 1 km (Centroid)"] = serviceAreaLayer;
          if (densityZoneLayer) overlays["üü• Zona Kepadatan (Centroid)"] = densityZoneLayer;

          L.control.layers(baseMaps, overlays, { collapsed: false }).addTo(map);
        }, 300);

        // Add geocoder
        L.Control.geocoder({
          defaultMarkGeocode: false,
          placeholder: "Cari lokasi di peta..."
        })
        .on("markgeocode", function(e) {
          map.fitBounds(e.geocode.bbox);
        })
        .addTo(map);

      })
      .catch(err => console.error("Gagal memuat GeoJSON:", err));

    // Pencarian apotek lokal (search box)
    document.getElementById("search-apotek").addEventListener("keyup", function (e) {
      const query = e.target.value.toLowerCase().trim();
      if (!query) return;
      const found = apotekData.find(a => a.name.includes(query));
      if (found) {
        map.setView(found.layer.getLatLng(), 17);
        found.layer.openPopup();
      }
    });

    // Tombol geolokasi pengguna
    document.getElementById("locate-btn").addEventListener("click", () => {
      if (!navigator.geolocation) {
        alert("Browser tidak mendukung geolokasi!");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          const userIcon = L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/149/149060.png",
            iconSize: [28, 28],
            iconAnchor: [14, 28],
          });
          const userMarker = L.marker([latitude, longitude], { icon: userIcon }).addTo(map);
          userMarker.bindPopup("<b>Lokasi Anda Saat Ini</b>").openPopup();
          map.setView([latitude, longitude], 16);
        },
        err => alert("Tidak dapat mengambil lokasi: " + err.message)
      );
    });

    // Tombol download GeoJSON
    document.getElementById("download-btn").addEventListener("click", () => {
      fetch("map.geojson")
        .then(res => res.blob())
        .then(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "data_apotek_sukabumi.geojson";
          a.click();
          URL.revokeObjectURL(url);
        });
    });

    // Skala & klik koordinat
    L.control.scale({ position: 'bottomleft' }).addTo(map);
    map.on('click', function(e) {
      L.popup()
        .setLatLng(e.latlng)
        .setContent("üìç Koordinat: " + e.latlng.lat.toFixed(5) + ", " + e.latlng.lng.toFixed(5))
        .openOn(map);
    });
  </script>
</body>
</html>