<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peta EPSG:4326 - Sebaran Apotek di Kota Sukabumi</title>

  <!-- Leaflet & Bootstrap -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Poppins", Arial, sans-serif;
      background-color: #f8f9fa;
    }

    h1 {
      background: linear-gradient(90deg, #0b4d9c, #1565c0);
      color: white;
      text-align: center;
      padding: 14px 0;
      margin: 0;
      font-size: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    #map {
      height: 92vh;
      width: 100%;
      border-top: 2px solid #0b4d9c;
    }

    .back-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      color: #0b4d9c;
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
    }

    .back-btn:hover {
      background: #0b4d9c;
      color: white;
    }

    .locate-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 1000;
      background: #0b4d9c;
      color: white;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      cursor: pointer;
      transition: 0.2s;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
    }

    .locate-btn:hover {
      background: #1976d2;
      transform: scale(1.05);
    }

    .search-box {
      position: absolute;
      top: 70px;
      left: 15px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      padding: 6px 10px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
    }

    .search-box input {
      border: none;
      outline: none;
      width: 200px;
      font-size: 0.9rem;
    }

    .legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.9rem;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
      line-height: 1.4em;
    }

    .legend h6 {
      margin-top: 0;
      font-weight: 600;
      color: #0b4d9c;
    }

    .legend i {
      width: 16px;
      height: 16px;
      float: left;
      margin-right: 8px;
      border-radius: 3px;
    }

    .leaflet-tooltip {
      background-color: #0b4d9c;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 4px 8px;
      font-size: 0.85rem;
    }
  </style>
</head>

<body>
  <h1>Peta EPSG:4326 - Sebaran Apotek di Kota Sukabumi</h1>
  <a href="index.html" class="back-btn">‚Üê Kembali</a>
  <button id="locate-btn" class="locate-btn" title="Tampilkan Lokasi Saya">üìç</button>

  <!-- Search box -->
  <div class="search-box">
    <input type="text" id="search-apotek" placeholder="üîé Cari apotek..." />
  </div>

  <div id="map"></div>

  <!-- Legenda -->
  <div class="legend">
    <h6>Legenda</h6>
    <div><i style="background:#28a745;"></i> Area (Polygon)</div>
    <div><i style="background:#007bff;"></i> Jalur (Polyline)</div>
    <div><img src="https://cdn-icons-png.flaticon.com/512/2966/2966327.png" width="16" style="margin-right:8px;"> Titik Apotek</div>
  </div>

  <script>
    // Inisialisasi peta dengan EPSG:4326
    var map = L.map('map', {
      crs: L.CRS.EPSG4326,
      center: [-6.919, 106.926],
      zoom: 13
    });

    // Basemap WMS
    var naturalEarth = L.tileLayer.wms("https://ahocevar.com/geoserver/wms", {
      layers: 'ne:NE1_HR_LC_SR_W_DR',
      format: 'image/png',
      transparent: false,
      attribution: "¬© Natural Earth"
    }).addTo(map);

    var satellite = L.tileLayer.wms("https://ows.terrestris.de/osm/service?", {
      layers: "S2cloudless",
      format: "image/png",
      transparent: false,
      attribution: "¬© Terrestris"
    });

    // Layer groups
    var markerLayer = L.layerGroup();
    var polylineLayer = L.layerGroup();
    var polygonLayer = L.layerGroup();
    var apotekData = [];

    var apotekIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/2966/2966327.png",
      iconSize: [28, 28],
      iconAnchor: [14, 28],
      popupAnchor: [0, -20]
    });

    // Muat GeoJSON
    fetch("map.geojson")
      .then(res => res.json())
      .then(data => {
        L.geoJSON(data, {
          pointToLayer: (feature, latlng) => L.marker(latlng, { icon: apotekIcon }),
          style: feature => {
            if (feature.geometry.type === "LineString") return { color: "#007bff", weight: 2, dashArray: "5,5" };
            if (feature.geometry.type === "Polygon") return { color: "#28a745", fillOpacity: 0.3 };
          },
          onEachFeature: (feature, layer) => {
            const nama = feature.properties["Nama"] || feature.properties["Nama "] || "Apotek";
            layer.bindTooltip(nama, { direction: "top" });
            layer.bindPopup(`<b>${nama}</b><br><small>Koordinat: ${feature.geometry.coordinates}</small>`);

            if (feature.geometry.type === "Point") {
              markerLayer.addLayer(layer);
              apotekData.push({ name: nama.toLowerCase(), layer });
            }
            if (feature.geometry.type === "LineString") polylineLayer.addLayer(layer);
            if (feature.geometry.type === "Polygon") polygonLayer.addLayer(layer);
          }
        });
      });

    // Layer control
    L.control.layers(
      { "üó∫Ô∏è Natural Earth": naturalEarth, "üõ∞Ô∏è Satellite": satellite },
      { "üè• Titik Apotek": markerLayer, "üõ£Ô∏è Jalur": polylineLayer, "üìç Area": polygonLayer },
      { collapsed: false }
    ).addTo(map);

    // Tombol lokasi saya
    document.getElementById("locate-btn").addEventListener("click", () => {
      if (!navigator.geolocation) {
        alert("Browser tidak mendukung geolokasi!");
        return;
      }

      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        const userMarker = L.marker([latitude, longitude], {
          icon: L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/149/149060.png",
            iconSize: [26, 26],
            iconAnchor: [13, 26]
          })
        }).addTo(map);

        userMarker.bindPopup("<b>Lokasi Anda</b>").openPopup();
        map.setView([latitude, longitude], 15);
      });
    });

    // Pencarian apotek
    document.getElementById("search-apotek").addEventListener("keyup", e => {
      const query = e.target.value.toLowerCase().trim();
      if (!query) return;
      const found = apotekData.find(a => a.name.includes(query));
      if (found) {
        map.setView(found.layer.getLatLng(), 17);
        found.layer.openPopup();
      }
    });
  </script>
</body>
</html>