<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peta Sebaran Apotek di Kota Sukabumi</title>

  <!-- Leaflet & Bootstrap -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Plugin Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Poppins", "Segoe UI", sans-serif;
      background-color: #eef2f7;
    }

    h1 {
      background: linear-gradient(90deg, #0b3c91, #1e6bd6);
      color: #fff;
      text-align: center;
      padding: 16px 0;
      margin: 0;
      font-size: 1.7rem;
      letter-spacing: 0.8px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.25);
    }

    #map {
      height: 92vh;
      width: 100%;
      border-top: 2px solid #0b3c91;
    }

    /* Tombol kembali */
    .back-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      color: #0b3c91;
      border: none;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 10px;
      transition: all 0.25s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
    }

    .back-btn:hover {
      background: #0b3c91;
      color: #fff;
      transform: translateY(-2px);
    }

    /* Tombol lokasi */
    .locate-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 1000;
      background: #0b3c91;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 46px;
      height: 46px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.25s;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
    }

    .locate-btn:hover {
      background: #1e6bd6;
      transform: scale(1.07);
    }

    /* Kotak pencarian */
    .search-box {
      position: absolute;
      top: 75px;
      left: 15px;
      z-index: 1000;
      background: #fff;
      border-radius: 10px;
      padding: 8px 12px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .search-box input {
      border: none;
      outline: none;
      width: 200px;
      font-size: 0.95rem;
    }

    /* Tombol download */
    #download-btn {
      z-index: 1000;
      font-size: 0.9rem;
      padding: 8px 14px;
      border-radius: 8px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
      transition: 0.25s;
    }

    #download-btn:hover {
      transform: scale(1.05);
    }

    /* Legenda */
    .legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 0.9rem;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
      line-height: 1.5em;
    }

    .legend h6 {
      margin: 0 0 6px;
      font-weight: 600;
      color: #0b3c91;
    }

    .legend i {
      width: 16px;
      height: 16px;
      float: left;
      margin-right: 8px;
      border-radius: 3px;
    }

    /* Popup dan tooltip */
    .leaflet-popup-content {
      font-size: 0.9rem;
    }

    .leaflet-tooltip {
      background-color: #0b3c91;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 4px 8px;
      font-size: 0.85rem;
      font-weight: 500;
    }
  </style>
</head>

<body>
  <h1>üó∫Ô∏è Peta Sebaran Apotek di Kota Sukabumi</h1>

  <!-- Tombol Navigasi -->
  <a href="index.html" class="back-btn">‚Üê Kembali</a>
  <button id="locate-btn" class="locate-btn" title="Tampilkan Lokasi Saya">üìç</button>

  <!-- Search box -->
  <div class="search-box">
    <span>üîé</span>
    <input type="text" id="search-apotek" placeholder="Cari apotek..." />
  </div>

  <div id="map"></div>

  <!-- Tombol download -->
  <button id="download-btn" class="btn btn-success position-absolute bottom-0 start-0 m-3">
    ‚¨áÔ∏è Unduh Data
  </button>

  <!-- Legenda -->
  <div class="legend">
    <h6>Legenda</h6>
    <div><i style="background:#28a745;"></i> Area (Polygon)</div>
    <div><i style="background:#007bff;"></i> Jalur (Polyline)</div>
    <div><img src="https://cdn-icons-png.flaticon.com/512/2966/2966327.png" width="16" style="margin-right:8px;"> Titik Apotek</div>
  </div>

  <script>
    // Inisialisasi peta
    var map = L.map("map").setView([-6.919, 106.926], 14);

    // Base maps
    var osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "¬© OpenStreetMap contributors"
    }).addTo(map);

    var satellite = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { attribution: "Tiles ¬© Esri" }
    );

    var topo = L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
      maxZoom: 17,
      attribution: "¬© OpenTopoMap contributors"
    });

    // Layer groups
    var markerLayer = L.layerGroup();
    var polylineLayer = L.layerGroup();
    var polygonLayer = L.layerGroup();

    // Icon apotek
    var apotekIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/2966/2966327.png",
      iconSize: [30, 30],
      iconAnchor: [15, 30],
      popupAnchor: [0, -28]
    });

    var apotekData = [];

    // Muat GeoJSON
    fetch("map.geojson")
      .then(res => res.json())
      .then(data => {
        const geojson = L.geoJSON(data, {
          pointToLayer: (feature, latlng) => L.marker(latlng, { icon: apotekIcon }),
          style: feature => {
            if (feature.geometry.type === "LineString")
              return { color: "#007bff", weight: 3, dashArray: "5, 5" };
            if (feature.geometry.type === "Polygon")
              return { color: "#28a745", fillOpacity: 0.4 };
          },
          onEachFeature: (feature, layer) => {
            const nama = feature.properties["Nama"] || feature.properties["Nama "] || "Apotek";
            const coords = feature.geometry.coordinates;
            layer.bindTooltip(nama, { direction: "top", offset: [0, -15] });
            layer.bindPopup(`
              <div style="text-align:center; line-height:1.4;">
                <h6 style="margin-bottom:5px;color:#0b3c91;font-weight:600">${nama}</h6>
                <p style="margin:2px 0;"><b>Alamat:</b> ${feature.properties.Alamat || "Tidak tersedia"}</p>
                <p style="margin:2px 0;"><b>Jam Buka:</b> ${feature.properties.Jam || "Tidak diketahui"}</p>
                <small><b>Koordinat:</b><br>${coords.join(", ")}</small>
              </div>
            `);

            // Efek highlight saat hover
            layer.on({
              mouseover: e => e.target.setStyle({ weight: 4, color: "#FFD700", fillOpacity: 0.7 }),
              mouseout: e => geojson.resetStyle(e.target)
            });

            if (feature.geometry.type === "Point") {
              markerLayer.addLayer(layer);
              apotekData.push({ name: nama.toLowerCase(), layer });
            }
            if (feature.geometry.type === "LineString") polylineLayer.addLayer(layer);
            if (feature.geometry.type === "Polygon") polygonLayer.addLayer(layer);
          }
        });

        // Tambah geocoder (pencarian global)
        L.Control.geocoder({
          defaultMarkGeocode: false,
          placeholder: "Cari lokasi di peta..."
        })
        .on("markgeocode", function(e) {
          map.fitBounds(e.geocode.bbox);
        })
        .addTo(map);
      })
      .catch(err => console.error("Gagal memuat GeoJSON:", err));

    // Pencarian apotek lokal
    document.getElementById("search-apotek").addEventListener("keyup", function (e) {
      const query = e.target.value.toLowerCase().trim();
      if (!query) return;
      const found = apotekData.find(a => a.name.includes(query));
      if (found) {
        map.setView(found.layer.getLatLng(), 17);
        found.layer.openPopup();
      }
    });

    // Tombol geolokasi pengguna
    document.getElementById("locate-btn").addEventListener("click", () => {
      if (!navigator.geolocation) {
        alert("Browser tidak mendukung geolokasi!");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          const userMarker = L.marker([latitude, longitude], {
            icon: L.icon({
              iconUrl: "https://cdn-icons-png.flaticon.com/512/149/149060.png",
              iconSize: [28, 28],
              iconAnchor: [14, 28],
            }),
          }).addTo(map);
          userMarker.bindPopup("<b>Lokasi Anda Saat Ini</b>").openPopup();
          map.setView([latitude, longitude], 16);
        },
        err => alert("Tidak dapat mengambil lokasi: " + err.message)
      );
    });

    // Tombol download GeoJSON
    document.getElementById("download-btn").addEventListener("click", () => {
      fetch("map.geojson")
        .then(res => res.blob())
        .then(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "data_apotek_sukabumi.geojson";
          a.click();
          URL.revokeObjectURL(url);
        });
    });

    // Layer control
    L.control.layers(
      { "üåç OpenStreetMap": osm, "üõ∞Ô∏è Satellite (ESRI)": satellite, "‚õ∞Ô∏è Topographic": topo },
      { "üè• Titik Apotek": markerLayer, "üõ£Ô∏è Jalur": polylineLayer, "üìç Area": polygonLayer },
      { collapsed: false }
    ).addTo(map);

    // Skala & klik koordinat
    L.control.scale({ position: 'bottomleft' }).addTo(map);
    map.on('click', function(e) {
      L.popup()
        .setLatLng(e.latlng)
        .setContent("üìç Koordinat: " + e.latlng.lat.toFixed(5) + ", " + e.latlng.lng.toFixed(5))
        .openOn(map);
    });
  </script>
</body>
</html>
