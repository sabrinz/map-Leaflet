<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peta Sebaran Apotek di Kota Sukabumi</title>

  <!-- Leaflet & Bootstrap -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Plugin Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Poppins", "Segoe UI", sans-serif;
      background-color: #f8f9fa;
    }

    h1 {
      background: linear-gradient(90deg, #0b3c91, #1e6bd6);
      color: white;
      text-align: center;
      padding: 14px 0;
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
    }

    #map {
      height: 92vh;
      width: 100%;
      border-top: 2px solid #0b3c91;
    }

    .back-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      color: #0b3c91;
      border: none;
      font-weight: 500;
      padding: 8px 14px;
      border-radius: 8px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
    }

    .back-btn:hover {
      background: #0b3c91;
      color: white;
    }

    .leaflet-control-layers {
      background-color: rgba(255, 255, 255, 0.95) !important;
      border-radius: 8px !important;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
      font-size: 0.9rem;
    }

    .leaflet-tooltip {
      background-color: #0b3c91;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 4px 8px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .locate-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 1000;
      background: #0b3c91;
      color: white;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      cursor: pointer;
      transition: 0.2s;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
    }

    .locate-btn:hover {
      background: #1e6bd6;
      transform: scale(1.05);
    }

    /* Input pencarian apotek */
    .search-box {
      position: absolute;
      top: 70px;
      left: 15px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      padding: 6px 10px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
    }

    .search-box input {
      border: none;
      outline: none;
      width: 200px;
      font-size: 0.9rem;
    }

    /* Legenda peta */
    .legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.9rem;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
      line-height: 1.4em;
    }

    .legend h6 {
      margin-top: 0;
      font-weight: 600;
      color: #0b3c91;
    }

    .legend i {
      width: 16px;
      height: 16px;
      float: left;
      margin-right: 8px;
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <h1>üó∫Ô∏è Peta Sebaran Apotek di Kota Sukabumi</h1>
  <a href="index.html" class="back-btn">‚Üê Kembali</a>
  <button id="locate-btn" class="locate-btn" title="Tampilkan Lokasi Saya">üìç</button>

  <!-- Search box -->
  <div class="search-box">
    <input type="text" id="search-apotek" placeholder="üîé Cari apotek..." />
  </div>

  <div id="map"></div>

  <!-- Legenda -->
  <div class="legend">
    <h6>Legenda</h6>
    <div><i style="background:#28a745;"></i> Area (Polygon)</div>
    <div><i style="background:#007bff;"></i> Jalur (Polyline)</div>
    <div><img src="https://cdn-icons-png.flaticon.com/512/2966/2966327.png" width="16" style="margin-right:8px;"> Titik Apotek</div>
  </div>

  <script>
    // Inisialisasi peta
    var map = L.map("map").setView([-6.919, 106.926], 14);

    // Base maps
    var osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "¬© OpenStreetMap contributors"
    }).addTo(map);

    var satellite = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { attribution: "Tiles ¬© Esri" }
    );

    // Layer groups
    var markerLayer = L.layerGroup();
    var polylineLayer = L.layerGroup();
    var polygonLayer = L.layerGroup();

    // Icon apotek
    var apotekIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/2966/2966327.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -28]
    });

    // Simpan data apotek untuk pencarian
    var apotekData = [];

    // Muat GeoJSON
    fetch("map.geojson")
      .then(res => res.json())
      .then(data => {
        L.geoJSON(data, {
          pointToLayer: (feature, latlng) => L.marker(latlng, { icon: apotekIcon }),
          style: feature => {
            if (feature.geometry.type === "LineString")
              return { color: "#007bff", weight: 3, dashArray: "5, 5" };
            if (feature.geometry.type === "Polygon")
              return { color: "#28a745", fillOpacity: 0.4 };
          },
          onEachFeature: (feature, layer) => {
            const nama = feature.properties["Nama"] || feature.properties["Nama "] || "Apotek";
            const coords = feature.geometry.coordinates;
            layer.bindTooltip(nama, { direction: "top", offset: [0, -15] });
            layer.bindPopup(`
              <div style="text-align:center">
                <h6 style="margin-bottom:5px;color:#0b3c91">${nama}</h6>
                <small><b>Koordinat:</b><br>${coords.join(", ")}</small>
              </div>
            `);

            if (feature.geometry.type === "Point") {
              markerLayer.addLayer(layer);
              apotekData.push({ name: nama.toLowerCase(), layer });
            }
            if (feature.geometry.type === "LineString") polylineLayer.addLayer(layer);
            if (feature.geometry.type === "Polygon") polygonLayer.addLayer(layer);
          }
        });

        // Pencarian global (alamat)
        L.Control.geocoder({
          defaultMarkGeocode: false,
          placeholder: "Cari lokasi di peta...",
        })
        .on("markgeocode", function(e) {
          map.fitBounds(e.geocode.bbox);
        })
        .addTo(map);
      })
      .catch(err => console.error("Gagal memuat GeoJSON:", err));

    // Pencarian apotek lokal
    document.getElementById("search-apotek").addEventListener("keyup", function (e) {
      const query = e.target.value.toLowerCase().trim();
      if (!query) return;

      const found = apotekData.find(a => a.name.includes(query));
      if (found) {
        map.setView(found.layer.getLatLng(), 17);
        found.layer.openPopup();
      }
    });

    // Tombol geolokasi pengguna
    document.getElementById("locate-btn").addEventListener("click", () => {
      if (!navigator.geolocation) {
        alert("Browser tidak mendukung geolokasi!");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          const userMarker = L.marker([latitude, longitude], {
            icon: L.icon({
              iconUrl: "https://cdn-icons-png.flaticon.com/512/149/149060.png",
              iconSize: [28, 28],
              iconAnchor: [14, 28],
            }),
          }).addTo(map);

          userMarker.bindPopup("<b>Lokasi Anda Saat Ini</b>").openPopup();
          map.setView([latitude, longitude], 16);
        },
        err => alert("Tidak dapat mengambil lokasi: " + err.message)
      );
    });

    // Layer control
    L.control.layers(
      { "üåç OpenStreetMap": osm, "üõ∞Ô∏è Satellite (ESRI)": satellite },
      { "üè• Titik Apotek": markerLayer, "üõ£Ô∏è Jalur": polylineLayer, "üìç Area": polygonLayer },
      { collapsed: false }
    ).addTo(map);
  </script>
</body>
</html>
