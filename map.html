<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peta Sebaran Apotek - Analisis GIS Sukabumi</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>

  <style>
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background-color: #f4f6f9;
    }

    h1 {
      background: linear-gradient(90deg, #0b3c91, #1e6bd6);
      color: #fff;
      text-align: center;
      padding: 16px 0;
      margin: 0;
      font-size: 1.7rem;
      letter-spacing: 1px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.25);
    }

    #map {
      height: calc(100vh - 65px);
      width: 100%;
    }

    /* BUTTON LOKASI */
    .locate-btn {
      position: absolute;
      top: 90px;
      left: 10px;
      z-index: 1000;
      background: #0b3c91;
      color: #fff;
      border: none;
      border-radius: 8px;
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(0,0,0,0.25);
    }

    /* SEARCH */
    .search-box {
      position: absolute;
      top: 140px;
      left: 10px;
      z-index: 1000;
      background: #fff;
      border-radius: 10px;
      padding: 8px 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.25);
      display: flex;
      align-items: center;
      gap: 8px;
      width: 220px;
    }
    .search-box input {
      border: none;
      outline: none;
      width: 185px;
    }

    /* BUTTON CUACA */
    #api-cuaca-btn {
      position: absolute;
      top: 90px;
      right: 10px;
      z-index: 1500;
      background: #0b3c91;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.25);
    }

    #download-btn {
      position: absolute;
      top: 140px;
      right: 10px;
      z-index: 1500;
      background: #28a745;
      color: #fff;
      border-radius: 10px;
      padding: 8px 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.25);
    }

    /* GPS PANEL */
    #gps-panel {
      position: absolute;
      top: 200px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 12px 15px;
      border-radius: 12px;
      width: 210px;
      font-size: 13px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.25);
    }

    /* FOLLOW GPS */
    #follow-gps {
      position: absolute;
      bottom: 90px;
      left: 10px;
      z-index: 1000;
      background: #0b3c91;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.25);
    }
    #follow-gps.following {
      background: #1e6bd6;
    }

    /* LEGEND STYLE */
    .legend {
      position: absolute;
      bottom: 20px;
      right: 15px;
      background: rgba(255,255,255,0.95);
      padding: 12px 15px;
      border-radius: 12px;
      font-size: 0.85rem;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    }
    .legend i, .legend img {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      float: left;
    }
  </style>
</head>

<body>
  <h1>üó∫Ô∏è Peta Sebaran Apotek Kota Sukabumi</h1>
  <button id="locate-btn" class="locate-btn" title="Tampilkan Lokasi Saya"><i class="fas fa-location-arrow"></i></button>

  <div class="search-box">
    <i class="fas fa-search" style="color:#0b3c91;"></i>
    <input type="text" id="search-apotek" placeholder="Cari apotek..." />
  </div>

  <button id="download-btn" title="Unduh GeoJSON"><i class="fas fa-download"></i> Unduh Data</button>
  <button id="api-cuaca-btn" title="Muat Layer Cuaca (Open-Meteo)"><i class="fas fa-cloud"></i> API Cuaca</button>

  <div id="map"></div>

  <div id="gps-panel">
    <b>GPS Realtime</b><br>
    Speed: <span id="gps-speed">-</span> km/h<br>
    Waktu: <span id="gps-time">-</span><br>
    Lat: <span id="gps-lat">-</span><br>
    Lng: <span id="gps-lng">-</span>
  </div>

  <button id="follow-gps" title="Toggle follow GPS">Follow GPS: OFF</button>

  <div class="legend">
    <h6 style="margin:0 0 6px 0;color:#0b3c91">Legenda</h6>
    <div style="clear:both"></div>
    <div style="margin-top:6px"><i style="background:#28a745;display:inline-block;"></i> Area (Polygon)</div>
    <div><i style="background:#007bff;display:inline-block;"></i> Jalur (Polyline)</div>
    <div><i style="background:#ffa500;display:inline-block;border-color:#ff8c00"></i> Buffer 500m</div>
    <div style="clear:both;margin-top:6px"><img src="https://cdn-icons-png.flaticon.com/512/2966/2966327.png" style="width:16px;height:16px;margin-right:8px;vertical-align:middle"> Titik Apotek</div>
  </div>

  <script>
    // ---------- Inisialisasi peta ----------
    const map = L.map('map').setView([-6.919, 106.926], 14);

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles ¬© Esri'
    });

    const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      maxZoom: 17, attribution: '¬© OpenTopoMap contributors'
    });

    // ---------- Layer Groups ----------
    const polylineLayer = L.layerGroup();
    const polygonLayer = L.layerGroup();
    const clusterLayer = L.markerClusterGroup({ spiderfyOnMaxZoom:false, showCoverageOnHover:false, zoomToBoundsOnClick:true });
    const individualBufferLayer = L.layerGroup();
    const weatherLayer = L.layerGroup();
    const apiLayer = L.layerGroup();

    let heatLayer = null;
    const centroidLayer = L.layerGroup();
    const serviceAreaLayer = L.layerGroup();
    const densityZoneLayer = L.layerGroup();

    // Icon apotek
    const apotekIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/2966/2966327.png',
      iconSize: [30,30],
      iconAnchor: [15,30],
      popupAnchor: [0,-28]
    });

    // untuk pencarian
    const apotekData = []; // { name, layer }

    // ---------- Utility: Open-Meteo ----------
    async function getWeather(lat, lon) {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=Asia%2FJakarta`;
      try {
        const r = await fetch(url);
        if (!r.ok) {
          console.warn('Open-Meteo HTTP', r.status);
          return null;
        }
        const j = await r.json();
        return j.current_weather || null;
      } catch (err) {
        console.warn('getWeather error', err);
        return null;
      }
    }

    function makeWeatherIcon(tempC) {
      const color = tempC >= 30 ? '#ff5722' : tempC >= 25 ? '#ff9800' : '#4fc3f7';
      const html = `<div style="background:${color};color:#fff;border-radius:6px;padding:3px 7px;font-weight:700;font-size:12px;">${Math.round(tempC)}¬∞C</div>`;
      return L.divIcon({ html, className: 'weather-divicon', iconSize: [46,18], iconAnchor: [23,-10] });
    }

    function getWeatherText(code) {
      const icons = {
        0: "‚òÄÔ∏è Cerah",1:"üå§Ô∏è Mostly Clear",2:"‚õÖ Berawan Sebagian",3:"‚òÅÔ∏è Mendung",
        45:"üå´Ô∏è Kabut",48:"üå´Ô∏è Kabut Beku",51:"üå¶Ô∏è Gerimis Ringan",53:"üåßÔ∏è Gerimis Sedang",
        55:"üåßÔ∏è Gerimis Lebat",61:"üå¶Ô∏è Hujan Ringan",63:"üåßÔ∏è Hujan Sedang",65:"üåßÔ∏è Hujan Lebat",
        66:"üå®Ô∏è Hujan Membeku",67:"üå®Ô∏è Freezing Rain",71:"‚ùÑÔ∏è Salju Ringan",73:"‚ùÑÔ∏è Salju Sedang",
        75:"‚ùÑÔ∏è Salju Lebat",80:"üå¶Ô∏è Hujan Lokal",81:"üåßÔ∏è Hujan Lebat Lokal",82:"‚õàÔ∏è Hujan Ekstrem",
        95:"‚õàÔ∏è Badai Petir",96:"‚õàÔ∏è Petir + Hujan Es",99:"üå©Ô∏è Badai Petir Ekstrem"
      };
      return icons[code] || "‚ùî Tidak Diketahui";
    }

    // ---------- Muat GeoJSON dan buat layer (map.geojson harus ada di folder yang sama) ----------
    let geojsonLayer = null;
    fetch('map.geojson')
      .then(r => r.json())
      .then(data => {
        geojsonLayer = L.geoJSON(data, {
          pointToLayer: (feature, latlng) => {
            // buat marker apotek
            const marker = L.marker(latlng, { icon: apotekIcon });
            // buffer per titik
            const buffer = L.circle(latlng, {
              radius: 500,
              color: '#ff8c00',
              fillColor: '#ffa500',
              fillOpacity: 0.12,
              weight: 1
            }).bindPopup(`Area Layanan 500m: <b>${feature.properties.Nama || 'Apotek'}</b>`);
            individualBufferLayer.addLayer(buffer);
            return marker;
          },
          style: feat => {
            if (!feat.geometry) return {};
            if (feat.geometry.type === 'LineString') return { color:'#007bff', weight:3, dashArray:'5,5' };
            if (feat.geometry.type === 'Polygon') return { color:'#28a745', fillOpacity:0.35, weight:1.5 };
            return {};
          },
          onEachFeature: (feature, layer) => {
            const nama = feature.properties && (feature.properties.Nama || feature.properties.name) ? (feature.properties.Nama || feature.properties.name) : 'Apotek';
            layer.bindTooltip(nama, { direction:'top', offset:[0,-15] });

            if (feature.geometry && feature.geometry.type === 'Point') {
              const latlng = layer.getLatLng();

              // klik marker -> popup + cuaca cepat
              layer.on('click', async () => {
                layer.bindPopup(`<div style="text-align:center"><b>${nama}</b><br><i>Memuat data cuaca...</i></div>`).openPopup();
                const weather = await getWeather(latlng.lat, latlng.lng);
                let cuacaHTML = '<i>Tidak tersedia</i>';
                if (weather) {
                  cuacaHTML = `${getWeatherText(weather.weathercode)}<br>üå°Ô∏è <b>${weather.temperature}¬∞C</b><br>üí® ${weather.windspeed} m/s`;
                }
                const popup = `<div style="text-align:center;line-height:1.4">
                  <h6 style="color:#0b3c91;margin:0 0 6px 0">${nama}</h6>
                  <p style="margin:2px 0"><b>Alamat:</b> ${feature.properties.Alamat || '-'}</p>
                  <hr style="margin:6px 0">
                  <b>‚òÅÔ∏è Cuaca</b><br>${cuacaHTML}
                  <hr style="margin:6px 0">
                  <small style="color:#666">Koordinat:<br>${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</small>
                </div>`;
                layer.bindPopup(popup).openPopup();

                // tambahkan ikon cuaca kecil ke weatherLayer (agar user bisa toggle)
                if (weather) {
                  const wIcon = makeWeatherIcon(weather.temperature);
                  const wMarker = L.marker([latlng.lat + 0.00008, latlng.lng], { icon: wIcon });
                  const emoji = (getWeatherText(weather.weathercode).split(' ')[0]) || '‚ùî';
                  const emojiMarker = L.marker([latlng.lat + 0.00024, latlng.lng], { icon: L.divIcon({ html:`<div style="font-size:18px">${emoji}</div>`, className:'cuaca-emoji' }) });
                  weatherLayer.addLayer(wMarker);
                  weatherLayer.addLayer(emojiMarker);
                }
              });

              clusterLayer.addLayer(layer);
              apotekData.push({ name: nama.toLowerCase(), layer });
            }

            if (feature.geometry && feature.geometry.type === 'LineString') polylineLayer.addLayer(layer);
            if (feature.geometry && feature.geometry.type === 'Polygon') polygonLayer.addLayer(layer);

            // hover effect (safe)
            layer.on({
              mouseover: e => {
                try { e.target.setStyle && e.target.setStyle({ weight:4, color:'#FFD700', fillOpacity:0.7 }); } catch(e){}
              },
              mouseout: e => {
                try { geojsonLayer && geojsonLayer.resetStyle && geojsonLayer.resetStyle(e.target); } catch(e){}
              }
            });
          }
        }).addTo(map);

        // tambahkan layer analysis & cluster
        clusterLayer.addTo(map);
        polylineLayer.addTo(map);
        polygonLayer.addTo(map);

        // buat analisis (heatmap, centroid, service area, density zone)
        setTimeout(() => {
          const markerPoints = [];
          clusterLayer.eachLayer(m => { if (m.getLatLng) markerPoints.push(m.getLatLng()); });

          if (markerPoints.length) {
            const heatPoints = markerPoints.map(p => [p.lat, p.lng, 0.7]);
            heatLayer = L.heatLayer(heatPoints, { radius: 30, blur: 20, maxZoom: 15 });

            // centroid
            let sumLat=0,sumLng=0;
            markerPoints.forEach(p => { sumLat+=p.lat; sumLng+=p.lng; });
            const centroid = { lat: sumLat/markerPoints.length, lng: sumLng/markerPoints.length };
            const centroidIcon = L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/854/854878.png', iconSize:[32,32], iconAnchor:[16,32] });
            L.marker([centroid.lat, centroid.lng], { icon: centroidIcon }).bindPopup(`<b>Pusat Kepadatan</b><br>${centroid.lat.toFixed(6)}, ${centroid.lng.toFixed(6)}`).addTo(centroidLayer);

            // service area 1 km
            L.circle([centroid.lat, centroid.lng], { radius:1000, color:'#00c853', fillColor:'#69f0ae', fillOpacity:0.18 }).bindPopup('Radius 1 km dari pusat kepadatan').addTo(serviceAreaLayer);

            // density zone
            const zoneSize = 0.004;
            L.polygon([
              [centroid.lat + zoneSize, centroid.lng - zoneSize],
              [centroid.lat + zoneSize, centroid.lng + zoneSize],
              [centroid.lat - zoneSize, centroid.lng + zoneSize],
              [centroid.lat - zoneSize, centroid.lng - zoneSize]
            ], { color:'#d50000', fillColor:'#ff1744', fillOpacity:0.25 }).bindPopup('<b>Zona Kepadatan (automatis)</b>').addTo(densityZoneLayer);

            heatLayer.addTo(map);
          }

          // layer control
          const baseMaps = { "üåç OpenStreetMap": osm, "üõ∞Ô∏è Satellite": satellite, "‚õ∞Ô∏è Topo": topo };
          const overlays = {
            "üè• Titik Apotek (Clustered)": clusterLayer,
            "üõ£Ô∏è Jalur": polylineLayer,
            "üó∫Ô∏è Area (Polygon)": polygonLayer,
            "üü† Buffer 500m (Per Apotek)": individualBufferLayer,
            "üî• Heatmap Kepadatan": heatLayer,
            "üìå Centroid Apotek": centroidLayer,
            "üü¢ Service Area 1 km": serviceAreaLayer,
            "üü• Zona Kepadatan": densityZoneLayer,
            "üå§Ô∏è Layer Cuaca (Open-Meteo)": weatherLayer,
            "üåê Data API Lokasi (Reverse)": apiLayer
          };
          L.control.layers(baseMaps, overlays, { collapsed:false }).addTo(map);
        }, 300);
      })
      .catch(err => {
        console.error('Gagal memuat GeoJSON:', err);
        alert('Gagal memuat file map.geojson. Pastikan file ada dan format valid.');
      });

    // ---------- Search box ----------
    document.getElementById('search-apotek').addEventListener('keyup', function(e) {
      const q = e.target.value.toLowerCase().trim();
      if (!q) return;
      const found = apotekData.find(a => a.name.includes(q));
      if (found && found.layer && found.layer.getLatLng) {
        map.setView(found.layer.getLatLng(), 17);
        found.layer.openPopup();
      }
    });

    // ---------- Tombol download GeoJSON ----------
    document.getElementById('download-btn').addEventListener('click', () => {
      fetch('map.geojson').then(r => r.blob()).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'data_apotek_sukabumi.geojson';
        a.click(); URL.revokeObjectURL(url);
      }).catch(err => alert('Gagal mengunduh: ' + err));
    });

    // ---------- Add Weather Layer (batched, ringan) ----------
    async function addWeatherLayer() {
      weatherLayer.clearLayers();
      if (!apotekData || apotekData.length === 0) { alert('Data apotek belum siap. Tunggu sebentar.'); return; }

      // batasi paralelisme (3 sekaligus) untuk efisiensi
      const concurrency = 3;
      let i = 0;
      async function worker() {
        while (i < apotekData.length) {
          const idx = i++;
          const item = apotekData[idx];
          const marker = item.layer;
          if (!marker || !marker.getLatLng) continue;
          const latlng = marker.getLatLng();

          const weather = await getWeather(latlng.lat, latlng.lng);
          if (!weather) continue;
          const wIcon = makeWeatherIcon(weather.temperature);
          const wMarker = L.marker([latlng.lat + 0.00008, latlng.lng], { icon: wIcon }).bindPopup(`<b>${item.name}</b><br>Suhu: ${weather.temperature}¬∞C<br>Angin: ${weather.windspeed} m/s`);
          weatherLayer.addLayer(wMarker);

          const emoji = (getWeatherText(weather.weathercode).split(' ')[0]) || '‚ùî';
          const emojiMarker = L.marker([latlng.lat + 0.00024, latlng.lng], { icon: L.divIcon({ html:`<div style="font-size:18px">${emoji}</div>`, className:'cuaca-emoji' }) });
          weatherLayer.addLayer(emojiMarker);

          // ringan pause
          await new Promise(r => setTimeout(r, 150));
        }
      }

      // start workers
      await Promise.all(Array.from({length: Math.min(concurrency, apotekData.length)}).map(worker));
      weatherLayer.addTo(map);
      alert('Layer cuaca dimuat. Gunakan Layer Control untuk on/off.');
    }

    document.getElementById('api-cuaca-btn').addEventListener('click', addWeatherLayer);

    // ---------- Geolocation: REALTIME using watchPosition ----------
    let gpsMarker = null;
    let gpsPolyline = L.polyline([], { color:'red', weight:3 }).addTo(map);
    let gpsHistory = [];
    let followGPS = false;
    const followBtn = document.getElementById('follow-gps');

    followBtn.addEventListener('click', () => {
      followGPS = !followGPS;
      followBtn.textContent = 'Follow GPS: ' + (followGPS ? 'ON' : 'OFF');
      followBtn.classList.toggle('following', followGPS);
    });

    function updateGpsPanel(coords, speed) {
      document.getElementById('gps-lat').textContent = coords.latitude.toFixed(6);
      document.getElementById('gps-lng').textContent = coords.longitude.toFixed(6);
      document.getElementById('gps-time').textContent = new Date().toLocaleTimeString();
      // speed sometimes null; convert m/s -> km/h if available
      if (typeof speed === 'number' && !isNaN(speed)) {
        const kmh = (speed * 3.6).toFixed(1);
        document.getElementById('gps-speed').textContent = kmh;
      } else {
        document.getElementById('gps-speed').textContent = '-';
      }
    }

    // start watchPosition (highAccuracy)
    if (navigator.geolocation) {
      const watchId = navigator.geolocation.watchPosition(
        pos => {
          const coords = pos.coords;
          // create or move marker
          if (!gpsMarker) {
            gpsMarker = L.marker([coords.latitude, coords.longitude], {
              icon: L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[40,40], iconAnchor:[20,40] })
            }).addTo(map);
          } else {
            gpsMarker.setLatLng([coords.latitude, coords.longitude]);
          }

          // history polyline
          gpsHistory.push([coords.latitude, coords.longitude]);
          gpsPolyline.setLatLngs(gpsHistory);

          // update panel
          updateGpsPanel(coords, coords.speed);

          // pan if follow
          if (followGPS) map.panTo([coords.latitude, coords.longitude]);
        },
        err => {
          console.warn('watchPosition error', err);
          if (err.code === 1) alert('Izin lokasi ditolak. Aktifkan izin lokasi untuk fitur GPS realtime.');
          else alert('Gagal mengambil lokasi: ' + err.message);
        },
        { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 }
      );

      // also quick locate button
      document.getElementById('locate-btn').addEventListener('click', () => {
        if (!gpsMarker) {
          alert('Menunggu lokasi... izinkan akses lokasi pada browser.');
          return;
        }
        map.setView(gpsMarker.getLatLng(), 16);
        gpsMarker.bindPopup('<b>Lokasi Anda Saat Ini</b>').openPopup();
      });
    } else {
      alert('Browser tidak mendukung geolocation API.');
      document.getElementById('locate-btn').disabled = true;
    }

    // ---------- Scale & clickable coords ----------
    L.control.scale({ position:'bottomleft' }).addTo(map);
    map.on('click', e => {
      L.popup().setLatLng(e.latlng).setContent('üìç Koordinat: ' + e.latlng.lat.toFixed(5) + ', ' + e.latlng.lng.toFixed(5)).openOn(map);
    });

    // clean console note
    console.log('Peta siap. Pastikan file map.geojson berada di folder yang sama dengan HTML.');
  </script>
</body>
</html>
